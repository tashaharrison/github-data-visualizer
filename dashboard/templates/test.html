<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chart Test - GitHub PR Analytics</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <div class="container mt-5">
        <h1>Chart Test Page</h1>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Test Chart</h5>
                    </div>
                    <div class="card-body">
                        <div id="testChart"></div>
                        <button class="btn btn-primary mt-3" onclick="loadTestChart()">
                            Load Test Chart
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>API Test</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-success" onclick="testHealth()">Health Check</button>
                        <button class="btn btn-info" onclick="testReports()">Test Reports</button>
                        <button class="btn btn-warning" onclick="testCharts()">Test Charts</button>
                        <div id="apiResults" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Console Output</h5>
                    </div>
                    <div class="card-body">
                        <pre id="consoleOutput" style="height: 200px; overflow-y: auto; background: #f8f9fa; padding: 10px;"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function log(message) {
            const output = document.getElementById('consoleOutput');
            const timestamp = new Date().toLocaleTimeString();
            output.textContent += `[${timestamp}] ${message}\n`;
            output.scrollTop = output.scrollHeight;
            console.log(message);
        }

        function loadTestChart() {
            log('Loading test chart...');
            
            fetch('/api/test-chart')
                .then(response => {
                    log(`Response status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    log('Test chart data received: ' + JSON.stringify(data, null, 2));
                    
                    if (data.test_chart) {
                        Plotly.newPlot('testChart', data.test_chart.data, data.test_chart.layout);
                        log('Test chart rendered successfully');
                    } else {
                        log('No test chart data found');
                    }
                })
                .catch(error => {
                    log('Error loading test chart: ' + error.message);
                });
        }

        function testHealth() {
            log('Testing health endpoint...');
            
            fetch('/api/health')
                .then(response => response.json())
                .then(data => {
                    log('Health check result: ' + JSON.stringify(data, null, 2));
                    document.getElementById('apiResults').innerHTML = `
                        <div class="alert alert-success">
                            <strong>Health Check:</strong> ${data.status}<br>
                            Reports: ${data.reports_count}<br>
                            Visualizations: ${data.visualizations_count}
                        </div>
                    `;
                })
                .catch(error => {
                    log('Health check error: ' + error.message);
                    document.getElementById('apiResults').innerHTML = `
                        <div class="alert alert-danger">
                            Health check failed: ${error.message}
                        </div>
                    `;
                });
        }

        function testReports() {
            log('Testing reports endpoint...');
            
            fetch('/api/reports')
                .then(response => response.json())
                .then(data => {
                    log(`Found ${data.length} reports`);
                    if (data.length > 0) {
                        const firstReport = data[0];
                        log('First report: ' + firstReport.filename);
                        
                        document.getElementById('apiResults').innerHTML = `
                            <div class="alert alert-info">
                                <strong>Reports Test:</strong> Found ${data.length} reports<br>
                                First report: ${firstReport.filename}<br>
                                <button class="btn btn-sm btn-primary mt-2" onclick="testSpecificChart('${firstReport.filename}')">
                                    Test Chart for ${firstReport.filename}
                                </button>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    log('Reports test error: ' + error.message);
                });
        }

        function testCharts() {
            log('Testing charts endpoint...');
            
            fetch('/api/reports')
                .then(response => response.json())
                .then(reports => {
                    if (reports.length > 0) {
                        const firstReport = reports[0];
                        log(`Testing charts for: ${firstReport.filename}`);
                        
                        return fetch(`/api/charts/${firstReport.filename}`);
                    } else {
                        throw new Error('No reports available');
                    }
                })
                .then(response => response.json())
                .then(data => {
                    log('Charts test result: ' + JSON.stringify(data, null, 2));
                    
                    const chartCount = Object.keys(data).length;
                    document.getElementById('apiResults').innerHTML = `
                        <div class="alert alert-warning">
                            <strong>Charts Test:</strong> Generated ${chartCount} charts<br>
                            Chart types: ${Object.keys(data).join(', ')}
                        </div>
                    `;
                })
                .catch(error => {
                    log('Charts test error: ' + error.message);
                    document.getElementById('apiResults').innerHTML = `
                        <div class="alert alert-danger">
                            Charts test failed: ${error.message}
                        </div>
                    `;
                });
        }

        function testSpecificChart(filename) {
            log(`Testing specific chart for: ${filename}`);
            
            fetch(`/api/charts/${filename}`)
                .then(response => response.json())
                .then(data => {
                    log(`Chart data for ${filename}: ${JSON.stringify(data, null, 2)}`);
                    
                    if (Object.keys(data).length > 0) {
                        const firstChartKey = Object.keys(data)[0];
                        const chartData = data[firstChartKey];
                        
                        // Create a new div for this chart
                        const chartDiv = document.createElement('div');
                        chartDiv.id = 'specificChart';
                        chartDiv.style.height = '400px';
                        document.getElementById('apiResults').appendChild(chartDiv);
                        
                        Plotly.newPlot('specificChart', chartData.data, chartData.layout);
                        log(`Rendered chart: ${firstChartKey}`);
                    } else {
                        log('No charts available for this report');
                    }
                })
                .catch(error => {
                    log('Specific chart test error: ' + error.message);
                });
        }

        // Initialize
        log('Chart test page loaded');
        log('Plotly version: ' + (typeof Plotly !== 'undefined' ? 'Loaded' : 'Not loaded'));
    </script>
</body>
</html> 